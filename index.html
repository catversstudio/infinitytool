<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title id="pageTitle">Infinity Tool</title>
    <meta name="description" id="metaDesc" content="Explore tools and resources.">
    <meta name="keywords" id="metaKeys" content="tools, website, resources">

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/9546/9546087.png">

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="data.js"></script>

    <style>
        /* --- AESTHETIC WHITE THEME --- */
        :root { 
            --primary: #6366f1; 
            --bg-color: #f8fafc; 
            --panel-bg: rgba(255, 255, 255, 0.95); 
            --card-bg: rgba(255, 255, 255, 0.85); 
            --border: rgba(0, 0, 0, 0.06); 
            --text-main: #1e293b; 
            --text-muted: #64748b; 
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --shadow-hover: 0 20px 25px -5px rgba(99, 102, 241, 0.15), 0 10px 10px -5px rgba(99, 102, 241, 0.1);
            --success: #10b981; 
            --danger: #ef4444; 
        }
        
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow-x: hidden; font-family: 'Outfit', sans-serif; background-color: var(--bg-color); color: var(--text-main); }
        
        body {
            background-image: 
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(168, 85, 247, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(236, 72, 153, 0.1) 0px, transparent 50%);
            background-attachment: fixed;
            -webkit-user-select: none; user-select: none; -webkit-touch-callout: none;
        }

        .allow-copy { -webkit-user-select: text !important; user-select: text !important; cursor: text; }
        
        /* HEADER */
        header { 
            position: relative; z-index: 100; width: 92%; max-width: 1200px; margin: 20px auto 0 auto; padding: 1rem 0; 
            border-radius: 24px; background: rgba(255, 255, 255, 0.6); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.8); 
            box-shadow: 0 4px 20px rgba(0,0,0,0.03); 
            display: flex; justify-content: center; align-items: center; 
            transition: transform 0.2s ease;
        }
        header:active { transform: scale(0.98); }

        .logo { font-weight: 800; font-size: 1.5rem; letter-spacing: -0.5px; display: flex; align-items: center; gap: 12px; cursor: pointer; color: var(--text-main); }
        .logo i { color: var(--primary); font-size: 1.3rem; filter: drop-shadow(0 4px 6px rgba(99, 102, 241, 0.4)); }
        #exitBtn { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); padding: 6px 15px; border-radius: 20px; font-size: 0.8rem; }

        /* INSTALL BTN */
        #installAppBtn { display: none; margin: 1rem auto; background: var(--text-main); color: white; border: none; padding: 12px 25px; border-radius: 30px; font-weight: 700; cursor: pointer; box-shadow: 0 5px 20px rgba(0,0,0,0.1); animation: fadeIn 1s ease; transition: 0.2s; }
        #installAppBtn:hover { transform: scale(1.05); }

        /* INTRO & SEARCH */
        #introSection { width: 100%; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; text-align: center; padding: 3rem 1.5rem 1rem 1.5rem; margin: 0 auto; max-width: 800px; animation: fadeIn 0.8s ease; }
        #introTitle { font-size: 2.8rem; line-height: 1.1; margin: 0 0 10px 0; background: linear-gradient(to right, #4f46e5, #9333ea); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; letter-spacing: -1px; }
        #introSub { font-size: 1.1rem; color: var(--text-muted); margin: 0; font-weight: 500; max-width: 600px; }
        
        .search-container { width: 100%; max-width: 500px; margin-top: 2rem; position: relative; box-sizing: border-box; z-index: 200; transition: transform 0.2s; }
        .search-input { width: 100%; padding: 16px 20px 16px 55px; border-radius: 20px; border: 2px solid transparent; background: white; color: var(--text-main); font-family: 'Outfit', sans-serif; font-size: 1.1rem; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 15px rgba(0,0,0,0.05); box-sizing: border-box; }
        .search-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 10px 30px rgba(99, 102, 241, 0.15); }
        .search-icon { position: absolute; left: 22px; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 1.2rem; pointer-events: none; }

        /* SUGGESTIONS */
        .suggestions-box { position: absolute; top: 100%; left: 0; right: 0; margin-top: 5px; background: white; border: 1px solid var(--border); border-radius: 20px; max-height: 250px; overflow-y: auto; display: none; z-index: 1000; box-shadow: 0 15px 40px rgba(0,0,0,0.1); animation: slideUp 0.2s ease; }
        .suggestion-item { padding: 14px 20px; display: flex; align-items: center; gap: 12px; color: var(--text-main); cursor: pointer; border-bottom: 1px solid #f1f5f9; transition: 0.2s; font-weight: 500; }
        .suggestion-item:hover { background: #f8fafc; color: var(--primary); padding-left: 25px; }

        /* NAV */
        .nav-scroller { display: flex; gap: 12px; overflow-x: auto; padding: 1.5rem 20px; justify-content: flex-start; flex-wrap: nowrap; width: 100%; max-width: 1200px; margin: 0 auto; -webkit-overflow-scrolling: touch; }
        .nav-scroller::-webkit-scrollbar { display: none; }
        .nav-tab { background: white; border: 1px solid var(--border); padding: 0.7rem 1.4rem; border-radius: 16px; color: var(--text-muted); cursor: pointer; font-size: 0.95rem; font-weight: 600; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); flex-shrink: 0; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .nav-tab:active { transform: scale(0.95); }
        .nav-tab.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3); transform: scale(1.05); }
        .count-badge { background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 8px; font-size: 0.8em; margin-left: 6px; }

        /* CARDS */
        .container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 20px 40px 20px; flex: 1; box-sizing: border-box; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; width: 100%; }
        
        .card { background: var(--card-bg); border: 1px solid white; border-radius: 24px; overflow: hidden; position: relative; display: flex; flex-direction: column; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); box-shadow: var(--shadow-sm); cursor: pointer; -webkit-tap-highlight-color: transparent; }
        .card:hover { transform: translateY(-8px); box-shadow: var(--shadow-hover); border-color: rgba(99, 102, 241, 0.3); }
        .card:active { transform: scale(0.97); }
        
        .card-img-wrapper { width: 100%; height: 160px; background: #f1f5f9; overflow: hidden; position: relative; }
        .card img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; pointer-events: none; }
        .card:hover img { transform: scale(1.05); }
        
        .card-content { padding: 1.5rem; flex: 1; display: flex; flex-direction: column; }
        .card h3 { margin: 0 0 0.5rem 0; font-size: 1.25rem; color: var(--text-main); font-weight: 700; }
        .card-desc { margin: 0 0 1.2rem 0; font-size: 0.95rem; color: var(--text-muted); line-height: 1.6; flex-grow: 1; }
        
        .card-actions { display: flex; align-items: center; gap: 10px; margin-top: auto; }
        .copy-btn { flex: 1; background: white; border: 1px solid var(--border); color: var(--primary); padding: 12px; border-radius: 14px; font-size: 0.95rem; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 700; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .copy-btn:hover { background: var(--primary); color: white; box-shadow: 0 5px 15px rgba(99, 102, 241, 0.25); }
        .copy-btn:active { transform: scale(0.95); }
        
        .report-btn { width: 44px; height: 44px; border-radius: 14px; background: #fef2f2; border: 1px solid rgba(239, 68, 68, 0.1); color: #ef4444; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; }
        .report-btn:hover { background: #fee2e2; transform: rotate(10deg); }

        /* ADMIN */
        #adminPanel { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8fafc; padding: 0; box-sizing: border-box; overflow-y: auto; z-index: 5000; animation: slideUp 0.3s ease; }
        .admin-nav { display: flex; border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.8); padding: 15px 25px; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 10; backdrop-filter: blur(15px); }
        .admin-tab-btn { background: transparent; border: none; color: var(--text-muted); padding: 10px 20px; font-weight: 600; cursor: pointer; border-radius: 12px; transition: 0.2s; font-size: 1rem; }
        .admin-tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .admin-content { padding: 2rem; max-width: 900px; margin: 0 auto; }
        .admin-section { background: white; padding: 25px; border-radius: 24px; box-shadow: var(--shadow-sm); margin-bottom: 2rem; border: 1px solid var(--border); }
        
        input, select, textarea { width: 100%; background: #f8fafc; border: 1px solid #e2e8f0; color: var(--text-main); padding: 14px; border-radius: 14px; font-family: inherit; margin-bottom: 1rem; box-sizing: border-box; font-size: 1rem; transition: 0.2s; }
        input:focus, textarea:focus { background: white; border-color: var(--primary); outline: none; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }
        
        .btn { padding: 14px; border-radius: 14px; border: none; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 100%; font-size: 1rem; gap: 10px; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); }
        .btn-success { background: var(--success); color: white; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }
        .btn-danger { background: #fee2e2; color: #ef4444; border: 1px solid #fca5a5; }
        .btn-mini { padding: 6px 12px; font-size: 0.85rem; width: auto; border-radius: 8px; }
        
        .admin-result-card { background: #f8fafc; padding: 12px; border-radius: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e2e8f0; }

        /* AUTH MODAL */
        #loginModal { position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(5px); z-index: 6000; display: none; justify-content: center; align-items: center; animation: fadeIn 0.3s; }
        .login-box { background: white; padding: 2.5rem; border: 1px solid #e2e8f0; border-radius: 30px; width: 320px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.1); }
        .login-box h3 { color: var(--text-main); margin-bottom: 1.5rem; }

        footer { text-align: center; padding: 3rem; color: var(--text-muted); font-size: 0.9rem; margin-top: auto; opacity: 0.7; }
        
        body.corrupted { background: white !important; display: flex; justify-content: center; align-items: center; height: 100vh; }
        body.corrupted * { display: none !important; }
        body.corrupted::after { content: "SYSTEM LOCKED"; color: #ef4444; font-family: monospace; font-size: 2rem; font-weight: 800; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>

<header id="mainHeader">
    <div class="logo" id="siteLogo" onclick="handleLogoClick()"><i class="fas fa-infinity"></i> Infinity Tool</div>
    <button class="btn btn-danger btn-mini" onclick="exitAdmin()" id="exitBtn" style="display:none; position:absolute; right:20px;">Exit</button>
</header>

<div id="introSection">
    <h1 id="introTitle"></h1>
    <p id="introSub"></p>
    <button id="installAppBtn" onclick="installPWA()"><i class="fas fa-download"></i> Install App</button>
    <div class="search-container">
        <i class="fas fa-search search-icon"></i>
        <input type="text" id="searchInput" class="search-input" placeholder="Search for tools..." onkeyup="handleSearch(this.value)" oninput="showSuggestions(this.value)">
        <div id="searchSuggestions" class="suggestions-box"></div>
    </div>
</div>

<div class="nav-scroller" id="navContainer"></div>

<div class="container">
    <div id="adminPanel">
        <div class="admin-nav">
            <div class="admin-nav-tabs">
                <button class="admin-tab-btn active" onclick="switchAdminTab('dashboard')"><i class="fas fa-home"></i> Dashboard</button>
                <button class="admin-tab-btn" onclick="switchAdminTab('analysis')"><i class="fas fa-chart-pie"></i> Analytics</button>
            </div>
            <button class="btn-mini btn-danger" onclick="exitAdmin()">Close</button>
        </div>

        <div id="adminDashboardView" class="admin-content">
            <div class="admin-section">
                <h4 style="margin-top:0; color:var(--primary);"><i class="fas fa-search"></i> Manage Content</h4>
                <input type="text" id="adminSearch" placeholder="Type to find and edit..." onkeyup="adminSearchFunc()">
                <div id="adminSearchResults" style="max-height: 200px; overflow-y: auto;"></div>
            </div>

            <div class="admin-section">
                <h4 style="margin-top:0; color:var(--primary);"><i class="fas fa-plus-circle"></i> Add / Edit</h4>
                <input type="hidden" id="editPostId">
                <select id="postCatSelect"></select>
                <input type="text" id="postTitle" placeholder="Site Name">
                <input type="url" id="postLink" placeholder="Link URL">
                <input type="text" id="postImg" placeholder="Image Link (Optional)">
                <input type="text" id="postTags" placeholder="Tags (hidden keywords)">
                <textarea id="postDesc" rows="2" placeholder="Description"></textarea>
                <button class="btn btn-primary" onclick="performPublish()" id="publishBtn">Publish</button>
                <button class="btn btn-mini" style="margin-top:10px; background:#e2e8f0; color:#64748b;" onclick="clearForm()">Clear Form</button>
            </div>

            <div class="admin-section">
                <h4 style="margin-top:0; color:var(--primary);"><i class="fas fa-cog"></i> Settings</h4>
                
                <label style="font-size:0.85rem; color:#64748b; font-weight:600;">Manage Categories</label>
                <div style="display:flex; gap:10px; margin-bottom:1rem;">
                    <input type="text" id="newCatName" placeholder="New Category" style="margin-bottom:0;">
                    <button class="btn btn-primary" style="width:auto;" onclick="addCategory()">Add</button>
                </div>
                <div id="catList" style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:1.5rem;"></div>
                
                <label style="font-size:0.85rem; color:#64748b; font-weight:600;">Site Information</label>
                <input type="text" id="editIntroTitle" placeholder="Title">
                <input type="text" id="editIntroSub" placeholder="Subtitle">
                <button class="btn btn-mini" style="background:white; border:1px solid #cbd5e1; width:100%; margin-bottom:1rem;" onclick="saveHeader()">Update Header</button>
                <textarea id="aboutEditor" rows="3"></textarea>
                <button class="btn btn-mini" style="background:white; border:1px solid #cbd5e1; width:100%; margin-bottom:2rem;" onclick="saveAbout()">Save About Text</button>
                
                <hr style="border:0; border-top:1px dashed #e2e8f0; margin: 2rem 0;">

                <h4 style="margin-top:0; color:var(--text-main);"><i class="fas fa-lock"></i> Admin Security</h4>
                <p style="font-size:0.85rem; color:#64748b;">Change your login email and password.</p>
                <input type="email" id="newAdminEmail" placeholder="New Admin Email">
                <input type="text" id="newAdminPass" placeholder="New Admin Password">
                <button class="btn btn-mini" style="background:white; border:1px solid #cbd5e1; width:100%; margin-bottom:2rem;" onclick="saveCredentials()">Update Login Details</button>

                <hr style="border:0; border-top:1px dashed #e2e8f0; margin: 2rem 0;">
                
                <button class="btn btn-success" onclick="downloadDataFile()"><i class="fas fa-download"></i> Download data.js</button>
            </div>
        </div>

        <div id="adminAnalysisView" class="admin-content" style="display:none;">
            <div class="admin-section">
                <h2 style="margin-top:0;">Overview</h2>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px;">
                    <div style="background:#f1f5f9; padding:20px; border-radius:16px; text-align:center;">
                        <div style="font-size:2rem; font-weight:800; color:var(--primary);" id="totalClicksDisplay">0</div>
                        <div style="color:var(--text-muted);">Total Clicks</div>
                    </div>
                    <div style="background:#f1f5f9; padding:20px; border-radius:16px; text-align:center;">
                        <div style="font-size:2rem; font-weight:800; color:var(--success);" id="totalLinksDisplay">0</div>
                        <div style="color:var(--text-muted);">Active Links</div>
                    </div>
                </div>
                <h4>Top Trending</h4>
                <div id="trendingChart"></div>
            </div>
            
            <div class="admin-section">
                <h4 style="margin-top:0; color:#db2777;">SEO Manager</h4>
                <label style="font-size:0.85rem; color:#64748b;">Page Title</label>
                <input type="text" id="seoTitle">
                <label style="font-size:0.85rem; color:#64748b;">Meta Description</label>
                <textarea id="seoDesc" rows="3"></textarea>
                <label style="font-size:0.85rem; color:#64748b;">Keywords</label>
                <input type="text" id="seoKeywords">
                <button class="btn btn-primary" onclick="saveSEO()">Save SEO</button>
            </div>
        </div>
    </div>

    <div id="contentArea">
        <h2 id="sectionTitle" style="font-size: 2rem; margin-bottom: 2rem; text-align:center; font-weight:800; color:var(--text-main);"></h2>
        <div id="postGrid" class="grid"></div>
    </div>

    <div style="margin: 4rem auto; max-width:700px; text-align:center; padding:20px;">
        <h3 style="color:var(--text-main);">About Us</h3>
        <div id="aboutDisplay" style="color:var(--text-muted); line-height:1.8;"></div>
    </div>
</div>

<footer>&copy; 2026 CatVers Studio. All rights reserved.</footer>

<div id="loginModal">
    <div class="login-box">
        <h3>Admin Access</h3>
        <input type="email" id="loginEmail" placeholder="Email">
        <input type="password" id="loginPass" placeholder="Password">
        <button class="btn btn-primary" onclick="attemptLogin()">Login</button>
        <button class="btn btn-mini" style="margin-top:10px; background:transparent; color:#64748b;" onclick="closeLogin()">Cancel</button>
    </div>
</div>

<script>
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js'); }); }
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('installAppBtn').style.display = 'block'; });
    function installPWA() { if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then((choiceResult) => { if (choiceResult.outcome === 'accepted') { document.getElementById('installAppBtn').style.display = 'none'; } deferredPrompt = null; }); } }

    // --- AUTH LOGIC (CHANGEABLE) ---
    let authConfig = JSON.parse(localStorage.getItem('portalAuth')) || { e: "asiksingh.143@gmail.com", p: "Sky@root" };

    function saveCredentials() {
        const newE = document.getElementById('newAdminEmail').value;
        const newP = document.getElementById('newAdminPass').value;
        if(newE && newP) {
            authConfig = { e: newE, p: newP };
            localStorage.setItem('portalAuth', JSON.stringify(authConfig));
            alert("Login Details Updated Successfully!");
            document.getElementById('newAdminEmail').value = '';
            document.getElementById('newAdminPass').value = '';
        } else {
            alert("Please enter both a new email and password.");
        }
    }

    function handleSearch(val) {
        if(val.toLowerCase() === '#admin') {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchSuggestions').style.display = 'none';
            document.getElementById('loginModal').style.display = 'flex';
        } else {
            filterPosts();
        }
    }

    let logoTapCount = 0; let logoTapTimer;
    function handleLogoClick() {
        logoTapCount++;
        clearTimeout(logoTapTimer);
        logoTapTimer = setTimeout(() => { logoTapCount = 0; }, 800);
        if(logoTapCount === 3) {
            document.getElementById('loginModal').style.display = 'flex';
            logoTapCount = 0;
        }
    }

    function attemptLogin() {
        const e = document.getElementById('loginEmail').value;
        const p = document.getElementById('loginPass').value;
        if(e === authConfig.e && p === authConfig.p) {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPass').value = '';
            toggleAdminUI(true);
        } else {
            alert("Invalid Credentials");
        }
    }

    function closeLogin(){ document.getElementById('loginModal').style.display='none'; }
    function exitAdmin(){ toggleAdminUI(false); }

    document.addEventListener('keydown', e => { if((e.ctrlKey && (e.key==='I'||e.key==='u'||e.key==='s'||e.key==='p'))||e.key==='F12'){e.preventDefault(); if(e.key!=='s'&&e.key!=='p') triggerCorruption();} });
    document.addEventListener('contextmenu', e => e.preventDefault());
    function triggerCorruption(){ document.body.innerHTML=""; document.body.classList.add('corrupted'); alert("SYSTEM LOCKED"); }

    const dbData = window.infinityDB || { categories: [], posts: [], intro: {}, about: "", seo: {} };
    const localCats = JSON.parse(localStorage.getItem('portalCats')) || [];
    const localPosts = JSON.parse(localStorage.getItem('portalPosts')) || [];
    const deletedIds = JSON.parse(localStorage.getItem('portalDeleted')) || [];
    const deletedCatIds = JSON.parse(localStorage.getItem('portalDeletedCats')) || [];
    
    let seoData = JSON.parse(localStorage.getItem('portalSEO')) || dbData.seo || { title: "Infinity Tool", desc: "Best tools website.", keywords: "tools, free" };
    document.getElementById('pageTitle').innerText = seoData.title;
    document.getElementById('metaDesc').content = seoData.desc;
    document.getElementById('metaKeys').content = seoData.keywords;

    // --- LOGIC FIX: REMOVED AUTO-ADD "Useful Tools" ---
    let categories = [...dbData.categories, ...localCats.filter(l => !dbData.categories.some(d => d.id === l.id))].filter(c => !deletedCatIds.includes(c.id));
    let posts = [...dbData.posts, ...localPosts.filter(l => !dbData.posts.some(d => d.id === l.id))].filter(p => !deletedIds.includes(p.id));
    
    // Removed the "if categories.length === 0" fallback here

    let aboutText = localStorage.getItem('portalAbout') || dbData.about || "Welcome to Infinity Tool.";
    let introData = JSON.parse(localStorage.getItem('portalIntro')) || {title: dbData.intro?.title || "Welcome", sub: dbData.intro?.sub || "Explore tools"};
    let activeCatId=null;

    const save=()=>{ 
        const newCats = categories.filter(c => !dbData.categories.some(d => d.id === c.id));
        const newPosts = posts.filter(p => !dbData.posts.some(d => d.id === p.id));
        localStorage.setItem('portalCats',JSON.stringify(newCats)); 
        localStorage.setItem('portalPosts',JSON.stringify(newPosts)); 
        localStorage.setItem('portalIntro',JSON.stringify(introData)); 
        localStorage.setItem('portalAbout', aboutText);
        localStorage.setItem('portalDeleted', JSON.stringify(deletedIds));
        localStorage.setItem('portalDeletedCats', JSON.stringify(deletedCatIds));
        localStorage.setItem('portalSEO', JSON.stringify(seoData));
    };

    function toggleAdminUI(show){
        const els = { panel:document.getElementById('adminPanel'), exit:document.getElementById('exitBtn') };
        els.panel.style.display=show?'block':'none'; els.exit.style.display=show?'block':'none';
        if(show){
            document.getElementById('editIntroTitle').value=introData.title;
            document.getElementById('editIntroSub').value=introData.sub;
            document.getElementById('aboutEditor').value=aboutText;
            renderAdminSearch();
            document.getElementById('seoTitle').value = seoData.title;
            document.getElementById('seoDesc').value = seoData.desc;
            document.getElementById('seoKeywords').value = seoData.keywords;
            
            // Set current auth in settings inputs (masked for safety)
            document.getElementById('newAdminEmail').value = authConfig.e; 
            
            switchAdminTab('dashboard');
        }
        renderUI();
    }

    function switchAdminTab(tabName) {
        document.querySelectorAll('.admin-tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.admin-tab-btn[onclick="switchAdminTab('${tabName}')"]`).classList.add('active');
        document.getElementById('adminDashboardView').style.display = tabName === 'dashboard' ? 'block' : 'none';
        document.getElementById('adminAnalysisView').style.display = tabName === 'analysis' ? 'block' : 'none';
        if(tabName === 'analysis') renderAnalysis();
    }

    function renderAnalysis() {
        const totalClicks = posts.reduce((sum, p) => sum + (p.clicks || 0), 0);
        document.getElementById('totalClicksDisplay').innerText = totalClicks;
        document.getElementById('totalLinksDisplay').innerText = posts.length;
        const sorted = [...posts].sort((a,b) => (b.clicks || 0) - (a.clicks || 0)).slice(0, 5);
        const chart = document.getElementById('trendingChart');
        chart.innerHTML = '';
        const maxClick = sorted[0]?.clicks || 1;
        sorted.forEach(p => {
            const percent = ((p.clicks || 0) / maxClick) * 100;
            chart.innerHTML += `<div style="margin-bottom:10px;"><div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:4px;"><span>${p.title}</span> <span>${p.clicks||0}</span></div><div style="background:#e2e8f0; height:8px; border-radius:4px;"><div style="background:var(--primary); width:${percent}%; height:100%; border-radius:4px;"></div></div></div>`;
        });
    }

    function saveSEO() {
        seoData = { title: document.getElementById('seoTitle').value, desc: document.getElementById('seoDesc').value, keywords: document.getElementById('seoKeywords').value };
        save(); alert("SEO Settings Saved! Download data.js to apply permanently.");
        document.getElementById('pageTitle').innerText = seoData.title;
    }

    function showSuggestions(query) {
        if(query === '#admin') return; 
        const box = document.getElementById('searchSuggestions');
        if(query.length < 1) { box.style.display = 'none'; return; }
        const matches = posts.filter(p => p.title.toLowerCase().includes(query.toLowerCase())).slice(0, 5);
        if(matches.length > 0) {
            box.innerHTML = matches.map(p => `<div class="suggestion-item" onclick="selectSuggestion('${p.title}')"><i class="fas fa-search"></i> ${p.title}</div>`).join('');
            box.style.display = 'block';
        } else { box.style.display = 'none'; }
    }

    function selectSuggestion(title) {
        document.getElementById('searchInput').value = title;
        document.getElementById('searchSuggestions').style.display = 'none';
        filterPosts();
    }

    document.addEventListener('click', function(e) { if (!document.querySelector('.search-container').contains(e.target)) { document.getElementById('searchSuggestions').style.display = 'none'; } });

    function adminSearchFunc() {
        const query = document.getElementById('adminSearch').value.toLowerCase();
        const resDiv = document.getElementById('adminSearchResults');
        resDiv.innerHTML = '';
        if(query.length < 2) return;
        const results = posts.filter(p => p.title.toLowerCase().includes(query));
        results.forEach(p => {
            const div = document.createElement('div'); div.className = 'admin-result-card';
            div.innerHTML = `<div style="font-weight:600; color:var(--text-main);">${p.title}</div><div><button class="btn btn-primary btn-mini" onclick="loadPostForEdit(${p.id})">Edit</button><button class="btn btn-danger btn-mini" onclick="performDelete(${p.id})">Del</button></div>`;
            resDiv.appendChild(div);
        });
    }

    function loadPostForEdit(id) {
        const p = posts.find(x => x.id === id); if(!p) return;
        document.getElementById('editPostId').value = p.id;
        document.getElementById('postTitle').value = p.title;
        document.getElementById('postLink').value = p.link;
        document.getElementById('postImg').value = p.img;
        document.getElementById('postDesc').value = p.desc;
        document.getElementById('postTags').value = p.tags || ''; 
        document.getElementById('postCatSelect').value = p.catId;
        document.getElementById('publishBtn').innerText = "Update Post";
        document.getElementById('adminSearchResults').innerHTML = ''; document.getElementById('adminSearch').value = '';
    }

    function performPublish() {
        const id = document.getElementById('editPostId').value;
        const t=document.getElementById('postTitle').value, l=document.getElementById('postLink').value, i=document.getElementById('postImg').value, d=document.getElementById('postDesc').value, tags=document.getElementById('postTags').value, c=document.getElementById('postCatSelect').value;
        if(!t || !l) return alert("Title & Link Required");
        const newData = {id: id ? parseInt(id) : Date.now(), catId:c, title:t, link:l, img:i, desc:d, tags:tags, clicks:0};
        if(id) { const idx = posts.findIndex(x => x.id == id); if(idx !== -1) posts[idx] = { ...posts[idx], ...newData, clicks: posts[idx].clicks || 0 }; } else { posts.push(newData); }
        save(); clearForm(); alert("Published Successfully"); renderUI();
    }

    function performDelete(id) { if(confirm("Are you sure?")) { posts = posts.filter(p => p.id !== id); if(dbData.posts.some(d => d.id === id)) deletedIds.push(id); save(); renderUI(); adminSearchFunc(); } }
    
    function clearForm() { document.getElementById('editPostId').value = ''; ['postTitle','postLink','postImg','postDesc','postTags'].forEach(id=>document.getElementById(id).value=''); document.getElementById('publishBtn').innerText = "Publish"; }
    
    // DIRECT DOWNLOAD (No Password)
    function downloadDataFile() {
        const exportObj = { categories: categories, posts: posts, intro: introData, about: aboutText, seo: seoData };
        const fileContent = `/* INFINITY TOOL DATABASE */\nwindow.infinityDB = ${JSON.stringify(exportObj, null, 2)};`;
        const blob = new Blob([fileContent], { type: 'text/javascript' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'data.js'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    function trackClick(id) { const idx = posts.findIndex(p => p.id === id); if(idx !== -1) { posts[idx].clicks = (posts[idx].clicks || 0) + 1; save(); } }
    function reportLink(id) { const p = posts.find(p => p.id === id); if(!p) return; window.location.href = `mailto:asiksingh.143@gmail.com?subject=Broken Link: ${p.title}&body=Link: ${p.link}`; }

    // FIXED COPY
    function copyText(e, btn) {
        e.preventDefault(); e.stopPropagation();
        const textToCopy = btn.closest('.card-content').querySelector('p').innerText;
        navigator.clipboard.writeText(textToCopy).then(() => {
            btn.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => btn.innerHTML = '<i class="fas fa-copy"></i> Copy', 1500);
        });
    }

    function renderUI(){
        const els={nav:document.getElementById('navContainer'), sel:document.getElementById('postCatSelect'), list:document.getElementById('catList'), grid:document.getElementById('postGrid')};
        els.nav.innerHTML=''; els.sel.innerHTML=''; els.list.innerHTML=''; els.grid.innerHTML='';
        
        document.getElementById('introTitle').innerText=introData.title; document.getElementById('introSub').innerText=introData.sub; document.getElementById('aboutDisplay').innerText=aboutText;

        if(categories.length===0){ els.grid.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:3rem;color:#64748b;">No categories.</div>'; return; }
        if(!activeCatId && categories.length>0) activeCatId=categories[0].id;

        categories.forEach(cat=>{
            const count = posts.filter(p => p.catId === cat.id).length;
            const tab=document.createElement('div'); tab.className=`nav-tab ${activeCatId===cat.id?'active':''}`;
            tab.innerHTML = `${cat.name} <span class="count-badge">${count}</span>`;
            tab.onclick=()=>{activeCatId=cat.id; document.getElementById('searchInput').value=''; renderUI();};
            els.nav.appendChild(tab);
            const opt=document.createElement('option'); opt.value=cat.id; opt.textContent=cat.name; els.sel.appendChild(opt);
            const tag=document.createElement('div'); tag.className='cat-tag'; tag.innerHTML=`${cat.name} <i class="fas fa-times"></i>`; tag.onclick=()=>deleteCategory(cat.id); els.list.appendChild(tag);
        });

        const query = document.getElementById('searchInput').value.toLowerCase();
        let filtered = [];
        if(query.length > 0) {
            filtered = posts.filter(p => p.title.toLowerCase().includes(query) || p.desc.toLowerCase().includes(query) || (p.tags && p.tags.toLowerCase().includes(query)));
            document.getElementById('sectionTitle').textContent = `Search Results (${filtered.length})`;
        } else {
            const currCat=categories.find(c=>c.id===activeCatId);
            document.getElementById('sectionTitle').textContent=currCat?currCat.name:"";
            filtered = posts.filter(p=>p.catId===activeCatId);
        }

        if(filtered.length===0) els.grid.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:3rem;color:#64748b;">No sites found.</div>';
        
        filtered.forEach(post=>{
            const card=document.createElement('div'); card.className='card'; 
            const linkAction = `onclick="trackClick(${post.id}); window.open('${post.link}', '_blank');"`;
            const catName = categories.find(c=>c.id===post.catId)?.name.toLowerCase() || "";
            const isPhotoPrompt = catName.includes("photo prompt");
            
            let img=post.img; if(!img) img=`https://ui-avatars.com/api/?name=${encodeURIComponent(post.title)}&background=1e293b&color=fff&size=512`;
            
            // Note: pass event 'event' to copyText
            card.innerHTML=`<div class="card-img-wrapper" ${linkAction}><img src="${img}" onerror="this.src='https://ui-avatars.com/api/?name=${post.title}'"></div><div class="card-content"><h3 ${linkAction}>${post.title}</h3><p class="card-desc ${isPhotoPrompt?'allow-copy':''}">${post.desc}</p><div class="card-actions">${isPhotoPrompt ? `<button class="copy-btn" onclick="copyText(event, this)"><i class="fas fa-copy"></i> Copy</button>` : `<button class="copy-btn" ${linkAction}><i class="fas fa-external-link-alt"></i> Visit</button>`}<button class="report-btn" title="Report" onclick="reportLink(${post.id})"><i class="fas fa-exclamation-triangle"></i></button></div></div>`;
            els.grid.appendChild(card);
        });
    }

    function filterPosts() { renderUI(); }
    function saveHeader(){ introData={title:document.getElementById('editIntroTitle').value,sub:document.getElementById('editIntroSub').value}; save(); renderUI(); alert("Saved"); }
    function saveAbout(){ aboutText=document.getElementById('aboutEditor').value; localStorage.setItem('portalAbout',aboutText); renderUI(); alert("Saved"); }
    function addCategory(){ const n=document.getElementById('newCatName').value; if(n){categories.push({id:'cat_'+Date.now(),name:n}); save(); document.getElementById('newCatName').value=''; renderUI();} }
    function deleteCategory(id){ if(confirm("Delete?")) { categories = categories.filter(c => c.id !== id); if(dbData.categories.some(d => d.id === id)) deletedCatIds.push(id); if(activeCatId === id) activeCatId = categories[0]?.id; save(); renderUI(); } }
    
    renderUI();
</script>
</body>
</html>