<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title id="pageTitle">Infinity Tool</title>
    <meta name="description" id="metaDesc" content="Explore tools and resources.">
    <meta name="keywords" id="metaKeys" content="tools, website, resources">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#8b5cf6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/9546/9546087.png">

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="data.js"></script>

    <style>
        /* --- ORIGINAL DARK THEME --- */
        :root { 
            --primary: #8b5cf6; 
            --bg-dark: #020617; 
            --panel-bg: #020617; 
            --card-bg: rgba(30, 41, 59, 0.6); 
            --border: rgba(255, 255, 255, 0.1); 
            --text-main: #f1f5f9; 
            --text-muted: #94a3b8; 
            --success: #10b981; 
            --danger: #ef4444; 
        }
        
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow-x: hidden; font-family: 'Outfit', sans-serif; background-color: var(--bg-dark); color: var(--text-main); }
        
        body {
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(139, 92, 246, 0.15) 0%, transparent 40%), 
                radial-gradient(circle at 90% 80%, rgba(56, 189, 248, 0.15) 0%, transparent 40%);
            background-attachment: fixed;
            -webkit-user-select: none; user-select: none; -webkit-touch-callout: none;
        }

        .allow-copy { -webkit-user-select: text !important; user-select: text !important; cursor: text; }
        
        /* HEADER */
        header { 
            position: relative; z-index: 100; width: 92%; max-width: 1200px; margin: 20px auto 0 auto; padding: 0.8rem 0; 
            border-radius: 50px; background: rgba(30, 41, 59, 0.4); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5); 
            display: flex; justify-content: space-between; align-items: center; padding-left: 25px; padding-right: 25px; box-sizing: border-box; 
        }
        .logo { font-weight: 800; font-size: 1.4rem; letter-spacing: -0.5px; display: flex; align-items: center; gap: 12px; cursor: pointer; color: white; text-shadow: 0 0 20px rgba(139, 92, 246, 0.5); }
        .logo i { color: var(--primary); filter: drop-shadow(0 0 10px var(--primary-glow)); font-size: 1.2rem; }
        
        .user-avatar { width: 35px; height: 35px; background: var(--primary); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: 700; cursor: pointer; display: none; box-shadow: 0 0 15px var(--primary); }
        .login-btn-header { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 20px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4); }

        /* INTRO & SEARCH */
        #introSection { text-align: center; padding: 3rem 1.5rem; animation: fadeIn 0.8s ease; }
        #introTitle { font-size: 2.5rem; margin: 0 0 10px 0; background: linear-gradient(to bottom right, #ffffff 30%, #a78bfa 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; }
        #introSub { font-size: 1.1rem; color: var(--text-muted); margin: 0; }
        #installAppBtn { display: none; margin: 1rem auto; background: var(--primary); color: white; border: none; padding: 10px 25px; border-radius: 30px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4); }

        .search-container { width: 100%; max-width: 500px; margin: 2rem auto 0 auto; position: relative; z-index: 200; }
        .search-input { width: 100%; padding: 14px 20px 14px 55px; border-radius: 50px; border: 1px solid var(--border); background: rgba(255, 255, 255, 0.05); color: white; font-size: 1rem; transition: 0.3s; box-sizing: border-box; }
        .search-input:focus { outline: none; border-color: var(--primary); background: rgba(0,0,0,0.3); box-shadow: 0 0 20px rgba(139, 92, 246, 0.3); }
        .search-icon { position: absolute; left: 22px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 1.1rem; }
        .suggestions-box { position: absolute; top: 100%; left: 0; right: 0; margin-top: 5px; background: #0f172a; border: 1px solid var(--border); border-radius: 20px; max-height: 250px; overflow-y: auto; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .suggestion-item { padding: 12px 20px; border-bottom: 1px solid rgba(255,255,255,0.03); cursor: pointer; color: var(--text-muted); }
        .suggestion-item:hover { background: rgba(139, 92, 246, 0.1); color: white; }

        /* NAV */
        .nav-scroller { display: flex; gap: 12px; overflow-x: auto; padding: 1.5rem 20px; justify-content: flex-start; max-width: 1200px; margin: 0 auto; scrollbar-width: none; }
        .nav-scroller::-webkit-scrollbar { display: none; }
        .nav-tab { background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 0.6rem 1.2rem; border-radius: 50px; color: var(--text-muted); cursor: pointer; font-weight: 600; white-space: nowrap; transition: 0.3s; flex-shrink: 0; }
        .nav-tab.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 0 25px rgba(139, 92, 246, 0.4); }
        .count-badge { background: rgba(0,0,0,0.2); padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-left: 6px; }

        /* CARDS */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px 40px 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }
        
        .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 20px; overflow: hidden; display: flex; flex-direction: column; transition: 0.3s; cursor: pointer; position: relative; backdrop-filter: blur(5px); }
        .card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .card-img-wrapper { height: 160px; background: #000; overflow: hidden; }
        .card img { width: 100%; height: 100%; object-fit: cover; }
        .card-content { padding: 1.5rem; flex: 1; display: flex; flex-direction: column; }
        .card h3 { margin: 0 0 0.5rem 0; font-size: 1.2rem; color: white; font-weight: 600; }
        .card-desc { margin: 0 0 1rem 0; font-size: 0.9rem; color: var(--text-muted); line-height: 1.5; flex-grow: 1; }
        .card-actions { display: flex; gap: 10px; margin-top: auto; }
        .copy-btn { flex: 1; background: rgba(255, 255, 255, 0.08); border: 1px solid var(--border); color: white; padding: 10px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .copy-btn:hover { background: rgba(255, 255, 255, 0.15); }
        .fav-btn { width: 40px; height: 40px; border-radius: 12px; background: rgba(236, 72, 153, 0.1); border: 1px solid rgba(236, 72, 153, 0.3); color: #ec4899; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; }
        .fav-btn.loved { background: #ec4899; color: white; box-shadow: 0 0 15px rgba(236, 72, 153, 0.4); }

        /* USER & ADMIN PANELS */
        #userPanel, #adminPanel { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--panel-bg); z-index: 5000; overflow-y: auto; padding-bottom: 50px; animation: slideUp 0.3s; }
        .panel-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: rgba(2, 6, 23, 0.9); backdrop-filter: blur(10px); z-index: 10; }
        .panel-title { font-size: 1.5rem; font-weight: 700; color: white; }
        .panel-content { padding: 20px; max-width: 900px; margin: 0 auto; }
        
        .cloud-input { width: 100%; padding: 15px; border: 1px solid var(--border); background: rgba(255,255,255,0.05); color: white; border-radius: 15px; margin-bottom: 15px; font-size: 1rem; box-sizing: border-box; }
        .cloud-btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 15px; font-weight: 700; cursor: pointer; font-size: 1rem; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3); }
        .status-msg { color: var(--text-muted); font-size: 0.9rem; margin-top: 10px; }

        /* Admin Specifics */
        .admin-section { margin-bottom: 2.5rem; padding-bottom: 2rem; border-bottom: 1px dashed var(--border); }
        .admin-nav { display: flex; gap: 10px; margin-right: auto; }
        .admin-tab-btn { background: transparent; border: 1px solid var(--border); color: var(--text-muted); padding: 8px 15px; border-radius: 10px; cursor: pointer; transition: 0.3s; }
        .admin-tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 20px; border-radius: 16px; text-align: center; }
        .stat-num { font-size: 2.5rem; font-weight: 800; color: white; margin: 5px 0; }
        
        .bar-item { margin-bottom: 15px; }
        .bar-info { display: flex; justify-content: space-between; font-size: 0.9rem; color: white; margin-bottom: 5px; }
        .bar-track { width: 100%; background: rgba(255,255,255,0.1); height: 10px; border-radius: 5px; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--primary); border-radius: 5px; width: 0%; transition: width 1s ease; }

        .admin-input { width: 100%; background: #1e293b; border: 1px solid var(--border); color: white; padding: 14px; border-radius: 12px; margin-bottom: 1rem; box-sizing: border-box; }
        .btn-primary { background: var(--primary); color: white; padding: 14px; border-radius: 12px; border: none; width: 100%; font-weight: 700; cursor: pointer; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3); }
        
        #loginModal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 6000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .login-box { background: #0f172a; padding: 2rem; border-radius: 20px; width: 300px; text-align: center; border: 1px solid var(--border); }

        footer { text-align: center; padding: 3rem; color: var(--text-muted); font-size: 0.9rem; margin-top: auto; border-top: 1px solid var(--border); }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<header>
    <div class="logo" id="siteLogo" onclick="handleLogoClick()"><i class="fas fa-infinity"></i> Infinity Tool</div>
    <div style="display:flex; gap:10px; align-items: center;">
        <button class="login-btn-header" onclick="openUserPanel()">Login</button>
        <div class="user-avatar" onclick="openUserPanel()">U</div>
    </div>
</header>

<div id="introSection">
    <h1 id="introTitle"></h1>
    <p id="introSub"></p>
    <button id="installAppBtn" onclick="installPWA()"><i class="fas fa-download"></i> Install App</button>
    <div class="search-container">
        <i class="fas fa-search search-icon"></i>
        <input type="text" id="searchInput" class="search-input" placeholder="Search tools..." onkeyup="handleSearch(this.value)" oninput="showSuggestions(this.value)">
        <div id="searchSuggestions" class="suggestions-box"></div>
    </div>
</div>

<div class="nav-scroller" id="navContainer"></div>

<div class="container">
    <div id="contentArea">
        <h2 id="sectionTitle" style="font-size: 1.8rem; margin: 2rem 0; font-weight:800; color:white; text-align: center;"></h2>
        <div id="postGrid" class="grid"></div>
    </div>
</div>

<div id="userPanel">
    <div class="panel-header">
        <div class="panel-title">Cloud Sync</div>
        <button onclick="closeUserPanel()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;"><i class="fas fa-times"></i></button>
    </div>
    <div class="panel-content">
        <div id="loggedOutView" style="text-align: center; padding: 40px 20px;">
            <h2 style="color:white;">Login Without Password</h2>
            <p style="color:var(--text-muted); margin-bottom:20px;">Enter your email. We will send you a Magic Link. Click it to log in securely.</p>
            
            <input type="email" id="emailInput" class="cloud-input" placeholder="name@example.com">
            <button class="cloud-btn" onclick="sendMagicLink()">Send Magic Link ðŸª„</button>
            <p class="status-msg" id="loginStatus"></p>
        </div>

        <div id="loggedInView" style="display:none;">
            <div style="background:rgba(255,255,255,0.05); padding:20px; border-radius:20px; text-align:center; border:1px solid var(--border);">
                <div style="width:60px; height:60px; background:var(--primary); color:white; border-radius:50%; font-size:1.5rem; font-weight:700; display:flex; align-items:center; justify-content:center; margin:0 auto 10px auto;" id="profileIcon">U</div>
                <h3 id="profileName" style="margin:0; color:white;">User</h3>
                <p id="profileEmail" style="color:var(--text-muted); font-size:0.9rem; margin-top:5px;"></p>
                <button onclick="logout()" style="margin-top:10px; background:rgba(239,68,68,0.2); color:#ef4444; border:1px solid #ef4444; padding:8px 16px; border-radius:20px; cursor:pointer;">Log Out</button>
            </div>

            <h3 style="margin-top:30px; color:white;"><i class="fas fa-heart" style="color:#db2777;"></i> Cloud Favorites</h3>
            <div id="favGrid" class="grid"></div>

            <h3 style="margin-top:30px; color:white;"><i class="fas fa-history" style="color:#3b82f6;"></i> Cloud History</h3>
            <div id="historyGrid" class="grid"></div>
        </div>
    </div>
</div>

<div id="adminPanel">
    <div class="panel-header">
        <div style="display:flex; align-items:center; gap:15px;">
            <div class="panel-title" style="color:var(--primary);">Dashboard</div>
            <div class="admin-nav">
                <button class="admin-tab-btn active" onclick="switchAdminTab('dashboard')"><i class="fas fa-home"></i></button>
                <button class="admin-tab-btn" onclick="switchAdminTab('analysis')"><i class="fas fa-chart-line"></i></button>
            </div>
        </div>
        <button onclick="exitAdmin()" style="background:none; border:none; color:white; font-size:1.2rem; cursor:pointer;"><i class="fas fa-times"></i></button>
    </div>
    <div class="panel-content">
        
        <div id="adminDashboardView">
            <div class="admin-section">
                <h4 style="margin-top:0; color:var(--primary);"><i class="fas fa-plus-circle"></i> Add Tool</h4>
                <input type="hidden" id="editPostId">
                <select id="postCatSelect" class="admin-input"></select>
                <input type="text" id="postTitle" class="admin-input" placeholder="Site Name">
                <input type="url" id="postLink" class="admin-input" placeholder="Link URL">
                <input type="text" id="postImg" class="admin-input" placeholder="Image URL">
                <input type="text" id="postTags" class="admin-input" placeholder="Tags (e.g. AI, Free)">
                <textarea id="postDesc" class="admin-input" rows="2" placeholder="Description"></textarea>
                <button class="btn-primary" onclick="performPublish()" id="publishBtn">Publish</button>
                <button onclick="clearForm()" style="width:100%; padding:10px; background:transparent; border:1px solid var(--border); color:var(--text-muted); margin-top:10px; border-radius:12px; cursor:pointer;">Clear Form</button>
            </div>

            <div class="admin-section">
                <h4 style="margin-top:0; color:var(--primary);"><i class="fas fa-cog"></i> Settings</h4>
                
                <label style="font-size:0.9rem; color:var(--text-muted);">Admin Security (Local)</label>
                <input type="email" id="newAdminEmail" class="admin-input" placeholder="New Admin Email">
                <input type="text" id="newAdminPass" class="admin-input" placeholder="New Admin Password">
                <button class="btn-primary" style="background:#475569; margin-bottom:20px;" onclick="saveCredentials()">Update Login</button>

                <label style="font-size:0.9rem; color:var(--text-muted);">Categories</label>
                <div style="display:flex; gap:10px; margin-bottom:1rem;">
                    <input type="text" id="newCatName" class="admin-input" placeholder="New Category" style="margin-bottom:0;">
                    <button class="btn-primary" style="width:auto;" onclick="addCategory()">Add</button>
                </div>
                
                <label style="font-size:0.9rem; color:var(--text-muted);">Header & About</label>
                <input type="text" id="editIntroTitle" class="admin-input" placeholder="Title">
                <input type="text" id="editIntroSub" class="admin-input" placeholder="Subtitle">
                <button class="btn-primary" style="background:transparent; border:1px solid var(--border); margin-bottom:1rem;" onclick="saveHeader()">Update Header</button>
                <textarea id="aboutEditor" class="admin-input" rows="3"></textarea>
                <button class="btn-primary" style="background:transparent; border:1px solid var(--border); margin-bottom:2rem;" onclick="saveAbout()">Save About Text</button>

                <label style="font-size:0.9rem; color:var(--text-muted);">Data Management</label>
                <button class="btn-primary" style="background:#10b981;" onclick="downloadDataFile()">Download Database</button>
            </div>
            
            <div class="admin-section">
                <h4 style="margin-top:0; color:white;">Edit Content</h4>
                <input type="text" id="adminSearch" class="admin-input" placeholder="Search to edit..." onkeyup="adminSearchFunc()">
                <div id="adminSearchResults"></div>
            </div>
        </div>

        <div id="adminAnalysisView" style="display:none;">
            <div class="admin-section">
                <h2 style="margin-top:0; color:white;">Traffic Overview</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-num" id="totalClicksDisplay">0</div>
                        <div style="color:var(--text-muted);">Total Clicks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-num" id="totalLinksDisplay">0</div>
                        <div style="color:var(--text-muted);">Active Links</div>
                    </div>
                </div>
                <h4 style="color:white;">Top 5 Trending</h4>
                <div id="trendingChart"></div>
            </div>
            
            <div class="admin-section">
                <h4 style="margin-top:0; color:#db2777;">SEO Manager</h4>
                <label style="font-size:0.9rem; color:var(--text-muted);">Page Title</label>
                <input type="text" id="seoTitle" class="admin-input">
                <label style="font-size:0.9rem; color:var(--text-muted);">Meta Description</label>
                <textarea id="seoDesc" class="admin-input" rows="3"></textarea>
                <label style="font-size:0.9rem; color:var(--text-muted);">Keywords</label>
                <input type="text" id="seoKeywords" class="admin-input">
                <button class="btn-primary" onclick="saveSEO()">Save SEO Settings</button>
            </div>
        </div>

    </div>
</div>

<div id="loginModal">
    <div class="login-box">
        <h3 style="color:white; margin-top:0;">Admin Access</h3>
        <input type="email" id="loginEmail" class="admin-input" placeholder="Email">
        <input type="password" id="loginPass" class="admin-input" placeholder="Password">
        <button class="btn-primary" onclick="attemptLogin()">Login</button>
        <button onclick="closeLogin()" style="margin-top:15px; background:none; border:none; color:var(--text-muted); cursor:pointer;">Cancel</button>
    </div>
</div>

<footer>&copy; 2026 CatVers Studio. All rights reserved.</footer>

<script>
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js'); }); }
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('installAppBtn').style.display = 'block'; });
    function installPWA() { if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then((choiceResult) => { if (choiceResult.outcome === 'accepted') { document.getElementById('installAppBtn').style.display = 'none'; } deferredPrompt = null; }); } }

    // --- 1. FIREBASE CONFIGURATION (PASTE YOUR KEYS HERE) ---
    // You need to replace these with your actual keys from Firebase Console
    const firebaseConfig = {
  apiKey: "AIzaSyD0Awm9fW3B-tE_Ds14oGtNgMtJTqiaAQY",
  authDomain: "infinity-tool.firebaseapp.com",
  projectId: "infinity-tool",
  storageBucket: "infinity-tool.firebasestorage.app",
  messagingSenderId: "311756913114",
  appId: "1:311756913114:web:06ea747f6d8771894ae8e3",
  measurementId: "G-KHHDWVME6L"
};

    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const auth = firebase.auth();
    const db = firebase.firestore();
    let currentUser = null;
    let userData = { favs: [], history: [] };

    // --- 2. AUTHENTICATION LOGIC (Passwordless) ---
    function sendMagicLink() {
        const email = document.getElementById('emailInput').value;
        const actionCodeSettings = {
            url: window.location.href, // Redirect back here
            handleCodeInApp: true
        };

        auth.sendSignInLinkToEmail(email, actionCodeSettings)
            .then(() => {
                window.localStorage.setItem('emailForSignIn', email);
                document.getElementById('loginStatus').innerText = "Link sent! Check your inbox.";
            })
            .catch((error) => {
                document.getElementById('loginStatus').innerText = "Error: " + error.message;
            });
    }

    // Check for incoming link on load
    if (auth.isSignInWithEmailLink(window.location.href)) {
        let email = window.localStorage.getItem('emailForSignIn');
        if (!email) {
            email = window.prompt('Please provide your email for confirmation');
        }
        auth.signInWithEmailLink(email, window.location.href)
            .then((result) => {
                window.localStorage.removeItem('emailForSignIn');
                // Remove query params from URL to clean up
                window.history.replaceState({}, document.title, window.location.pathname);
            })
            .catch((error) => {
                alert("Login Error: " + error.message);
            });
    }

    auth.onAuthStateChanged((user) => {
        currentUser = user;
        if (user) {
            // Logged In
            document.querySelector('.login-btn-header').style.display = 'none';
            document.querySelector('.user-avatar').style.display = 'flex';
            document.querySelector('.user-avatar').innerText = user.email.charAt(0).toUpperCase();
            
            document.getElementById('loggedOutView').style.display = 'none';
            document.getElementById('loggedInView').style.display = 'block';
            document.getElementById('profileName').innerText = user.displayName || "User";
            document.getElementById('profileEmail').innerText = user.email;
            document.getElementById('profileIcon').innerText = user.email.charAt(0).toUpperCase();
            
            loadUserData();
        } else {
            // Logged Out
            document.querySelector('.login-btn-header').style.display = 'block';
            document.querySelector('.user-avatar').style.display = 'none';
            document.getElementById('loggedOutView').style.display = 'block';
            document.getElementById('loggedInView').style.display = 'none';
            userData = { favs: [], history: [] };
            renderUserGrids();
            renderUI();
        }
    });

    function logout() { auth.signOut(); }

    // --- 3. DATA LOGIC (Firestore) ---
    function loadUserData() {
        if (!currentUser) return;
        db.collection('users').doc(currentUser.uid).onSnapshot(doc => {
            if (doc.exists) {
                userData = doc.data();
                renderUserGrids();
                renderUI();
            } else {
                db.collection('users').doc(currentUser.uid).set({ favs: [], history: [] });
            }
        });
    }

    function toggleFavorite(e, id) {
        e.stopPropagation();
        if (!currentUser) { openUserPanel(); return; }
        
        let newFavs = userData.favs || [];
        if (newFavs.includes(id)) { newFavs = newFavs.filter(fid => fid !== id); } 
        else { newFavs.push(id); }
        
        db.collection('users').doc(currentUser.uid).update({ favs: newFavs });
    }

    function addToHistory(id) {
        if (!currentUser) return;
        let newHist = userData.history || [];
        newHist = newHist.filter(hid => hid !== id);
        newHist.unshift(id);
        if (newHist.length > 20) newHist.pop();
        db.collection('users').doc(currentUser.uid).update({ history: newHist });
    }

    function renderUserGrids() {
        const favGrid = document.getElementById('favGrid');
        const histGrid = document.getElementById('historyGrid');
        favGrid.innerHTML = ''; histGrid.innerHTML = '';

        const favPosts = posts.filter(p => (userData.favs || []).includes(p.id));
        if(favPosts.length === 0) favGrid.innerHTML = '<p style="color:#94a3b8; text-align:center; grid-column:1/-1;">No favorites yet.</p>';
        else favPosts.forEach(p => favGrid.appendChild(createCard(p)));

        const histPosts = (userData.history || []).map(id => posts.find(p => p.id === id)).filter(p => p);
        if(histPosts.length === 0) histGrid.innerHTML = '<p style="color:#94a3b8; text-align:center; grid-column:1/-1;">No history yet.</p>';
        else histPosts.forEach(p => histGrid.appendChild(createCard(p)));
    }

    function openUserPanel() { document.getElementById('userPanel').style.display = 'block'; }
    function closeUserPanel() { document.getElementById('userPanel').style.display = 'none'; }

    // --- EXISTING LOGIC ---
    let authConfig = JSON.parse(localStorage.getItem('portalAuth')) || { e: "asiksingh.143@gmail.com", p: "Sky@root" };
    const dbData = window.infinityDB || { categories: [], posts: [], intro: {}, about: "", seo: {} };
    const localCats = JSON.parse(localStorage.getItem('portalCats')) || [];
    const localPosts = JSON.parse(localStorage.getItem('portalPosts')) || [];
    const deletedIds = JSON.parse(localStorage.getItem('portalDeleted')) || [];
    const deletedCatIds = JSON.parse(localStorage.getItem('portalDeletedCats')) || [];
    
    let seoData = JSON.parse(localStorage.getItem('portalSEO')) || dbData.seo || { title: "Infinity Tool", desc: "", keywords: "" };
    document.getElementById('pageTitle').innerText = seoData.title;
    
    let categories = [...dbData.categories, ...localCats.filter(l => !dbData.categories.some(d => d.id === l.id))].filter(c => !deletedCatIds.includes(c.id));
    let posts = [...dbData.posts, ...localPosts.filter(l => !dbData.posts.some(d => d.id === l.id))].filter(p => !deletedIds.includes(p.id));
    if(categories.length === 0) categories = [{id:'c1',name:'Start Here'}];

    let introData = JSON.parse(localStorage.getItem('portalIntro')) || dbData.intro;
    let activeCatId = categories[0]?.id;

    function createCard(post) {
        const div = document.createElement('div'); div.className = 'card';
        const isFav = (userData.favs || []).includes(post.id);
        
        div.onclick = () => {
            addToHistory(post.id);
            window.open(post.link, '_blank');
            trackClick(post.id);
        };

        let img = post.img || `https://ui-avatars.com/api/?name=${post.title}`;
        
        div.innerHTML = `
            <div class="card-img-wrapper"><img src="${img}" onerror="this.src='https://ui-avatars.com/api/?name=${post.title}'"></div>
            <div class="card-content">
                <h3>${post.title}</h3>
                <p class="card-desc">${post.desc}</p>
                <div class="card-actions">
                    <button class="copy-btn" onclick="copyText(event, this)">Copy</button>
                    <div class="fav-btn ${isFav ? 'loved' : ''}" onclick="toggleFavorite(event, ${post.id})">
                        <i class="${isFav ? 'fas' : 'far'} fa-heart"></i>
                    </div>
                </div>
            </div>
        `;
        return div;
    }

    function renderUI() {
        const nav = document.getElementById('navContainer');
        const grid = document.getElementById('postGrid');
        nav.innerHTML = ''; grid.innerHTML = '';
        
        document.getElementById('introTitle').innerText = introData?.title || "Welcome";
        document.getElementById('introSub').innerText = introData?.sub || "Explore tools";

        categories.forEach(cat => {
            const btn = document.createElement('div');
            btn.className = `nav-tab ${activeCatId === cat.id ? 'active' : ''}`;
            btn.innerText = cat.name;
            btn.onclick = () => { activeCatId = cat.id; document.getElementById('searchInput').value=''; renderUI(); };
            nav.appendChild(btn);
        });

        const query = document.getElementById('searchInput').value.toLowerCase();
        let filtered = query ? 
            posts.filter(p => p.title.toLowerCase().includes(query) || (p.tags && p.tags.toLowerCase().includes(query))) : 
            posts.filter(p => p.catId === activeCatId);

        if(filtered.length === 0) grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#94a3b8;">Nothing found here...</div>';
        filtered.forEach(p => grid.appendChild(createCard(p)));
        
        const sel = document.getElementById('postCatSelect');
        sel.innerHTML = '';
        categories.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id; opt.innerText = c.name;
            sel.appendChild(opt);
        });
    }

    // --- ADMIN LOGIC ---
    function handleSearch(val) { if(val === '#admin') document.getElementById('loginModal').style.display='flex'; else renderUI(); }
    let taps=0, timer; function handleLogoClick(){ taps++; clearTimeout(timer); timer=setTimeout(()=>taps=0,800); if(taps===3) document.getElementById('loginModal').style.display='flex'; }
    
    function attemptLogin(){
        if(document.getElementById('loginEmail').value === authConfig.e && document.getElementById('loginPass').value === authConfig.p) {
            document.getElementById('loginModal').style.display='none';
            document.getElementById('adminPanel').style.display='block';
            document.getElementById('newAdminEmail').value = authConfig.e;
            document.getElementById('newAdminPass').value = authConfig.p;
            switchAdminTab('dashboard');
        } else alert("Wrong credentials");
    }
    
    function switchAdminTab(tabName) {
        document.querySelectorAll('.admin-tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.admin-tab-btn[onclick="switchAdminTab('${tabName}')"]`).classList.add('active');
        document.getElementById('adminDashboardView').style.display = tabName === 'dashboard' ? 'block' : 'none';
        document.getElementById('adminAnalysisView').style.display = tabName === 'analysis' ? 'block' : 'none';
        if(tabName === 'analysis') renderAnalysis();
    }

    function renderAnalysis() {
        const totalClicks = posts.reduce((sum, p) => sum + (p.clicks || 0), 0);
        document.getElementById('totalClicksDisplay').innerText = totalClicks;
        document.getElementById('totalLinksDisplay').innerText = posts.length;
        const sorted = [...posts].sort((a,b) => (b.clicks || 0) - (a.clicks || 0)).slice(0, 5);
        const chart = document.getElementById('trendingChart');
        chart.innerHTML = '';
        const maxClick = sorted[0]?.clicks || 1;
        sorted.forEach(p => {
            const percent = ((p.clicks || 0) / maxClick) * 100;
            chart.innerHTML += `<div class="bar-item"><div class="bar-info"><span>${p.title}</span> <span>${p.clicks||0}</span></div><div class="bar-track"><div class="bar-fill" style="width:${percent}%"></div></div></div>`;
        });
    }

    function saveCredentials() {
        const e = document.getElementById('newAdminEmail').value;
        const p = document.getElementById('newAdminPass').value;
        if(e && p) {
            authConfig = {e, p};
            localStorage.setItem('portalAuth', JSON.stringify(authConfig));
            alert("Updated!");
        }
    }

    function save() {
        const newCats = categories.filter(c => !dbData.categories.some(d => d.id === c.id));
        const newPosts = posts.filter(p => !dbData.posts.some(d => d.id === p.id));
        localStorage.setItem('portalCats', JSON.stringify(newCats));
        localStorage.setItem('portalPosts', JSON.stringify(newPosts));
        localStorage.setItem('portalDeleted', JSON.stringify(deletedIds));
    }

    function performPublish() {
        const id = document.getElementById('editPostId').value;
        const t = document.getElementById('postTitle').value;
        const l = document.getElementById('postLink').value;
        const i = document.getElementById('postImg').value;
        const d = document.getElementById('postDesc').value;
        const tags = document.getElementById('postTags').value;
        const c = document.getElementById('postCatSelect').value;
        if(!t || !l) return alert("Title required");
        const newPost = { id: id ? parseInt(id) : Date.now(), catId: c, title: t, link: l, img: i, desc: d, tags: tags, clicks: 0 };
        if(id) { const idx = posts.findIndex(p => p.id == id); if(idx > -1) posts[idx] = {...posts[idx], ...newPost, clicks: posts[idx].clicks}; } else { posts.push(newPost); }
        save(); renderUI(); alert("Saved"); clearForm();
    }

    function downloadDataFile() {
        if(prompt("Confirm Password:") === authConfig.p) {
            const data = `window.infinityDB = ${JSON.stringify({categories, posts, intro: introData, seo: seoData}, null, 2)};`;
            const blob = new Blob([data], {type: 'text/javascript'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob); a.download = 'data.js';
            a.click();
        } else alert("Wrong password");
    }

    function clearForm(){ document.getElementById('editPostId').value=''; ['postTitle','postLink','postImg','postDesc', 'postTags'].forEach(id=>document.getElementById(id).value=''); }
    function closeLogin(){document.getElementById('loginModal').style.display='none';}
    function exitAdmin(){document.getElementById('adminPanel').style.display='none';}
    function copyText(e, btn) { e.stopPropagation(); navigator.clipboard.writeText(btn.closest('.card-content').querySelector('p').innerText); btn.innerText="Copied!"; setTimeout(()=>btn.innerText="Copy",1500); }
    function adminSearchFunc() {
        const query = document.getElementById('adminSearch').value.toLowerCase();
        const resDiv = document.getElementById('adminSearchResults');
        resDiv.innerHTML = '';
        if(query.length < 2) return;
        const results = posts.filter(p => p.title.toLowerCase().includes(query));
        results.forEach(p => {
            const div = document.createElement('div'); 
            div.style.cssText = 'background:rgba(255,255,255,0.05); padding:10px; margin-bottom:5px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;';
            div.innerHTML = `<span style="color:white;">${p.title}</span><button class="btn-primary" style="width:auto; padding:5px 10px; font-size:0.8rem;" onclick="loadPostForEdit(${p.id})">Edit</button>`;
            resDiv.appendChild(div);
        });
    }
    
    function loadPostForEdit(id) {
        const p = posts.find(x => x.id === id); if(!p) return;
        document.getElementById('editPostId').value = p.id;
        document.getElementById('postTitle').value = p.title;
        document.getElementById('postLink').value = p.link;
        document.getElementById('postImg').value = p.img;
        document.getElementById('postDesc').value = p.desc;
        document.getElementById('postTags').value = p.tags || '';
        document.getElementById('postCatSelect').value = p.catId;
    }
    
    function addCategory(){ const n=document.getElementById('newCatName').value; if(n){categories.push({id:'cat_'+Date.now(),name:n}); save(); document.getElementById('newCatName').value=''; renderUI();} }
    function saveHeader(){ introData={title:document.getElementById('editIntroTitle').value,sub:document.getElementById('editIntroSub').value}; localStorage.setItem('portalIntro',JSON.stringify(introData)); renderUI(); alert("Saved"); }
    function saveAbout(){ aboutText=document.getElementById('aboutEditor').value; localStorage.setItem('portalAbout',aboutText); alert("Saved"); }
    function saveSEO(){ seoData={title:document.getElementById('seoTitle').value, desc:document.getElementById('seoDesc').value, keywords:document.getElementById('seoKeywords').value}; localStorage.setItem('portalSEO',JSON.stringify(seoData)); document.getElementById('pageTitle').innerText=seoData.title; alert("Saved"); }
    function trackClick(id){ const p = posts.find(x => x.id === id); if(p) { p.clicks = (p.clicks || 0) + 1; save(); } }

    renderUI();
</script>
</body>
</html>